version: '3.8'

services:
  # -------------------------------------------------------------------------
  # POSTGRESQL (The Core Database)
  # Why: Stores our users, products, orders, and inventory persistently.
  # -------------------------------------------------------------------------
  postgres:
    image: postgres:14-alpine
    container_name: retail_postgres
    ports:
      - "5433:5432" # Changed to 5433 to avoid conflict with Windows Postgres
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres   # Simple password for local dev
      POSTGRES_DB: postgres        # Default database for our auth domain
    volumes:
      - postgres_data:/var/lib/postgresql/data # Persist data even if container dies
      - ./scripts/init-db.sql:/docker-entrypoint-initdb.d/init-db.sql 
      # this should only be used for local, docker-entrypoint-initdb.d is a place where we add sql
      # scripts to be run first time the container starts 

  # -------------------------------------------------------------------------
  # REDIS (The Cache & Quick Storage)
  # Why: Holds our shopping carts (fast read/write) and locks inventory temporarily.
  # -------------------------------------------------------------------------
  redis:
    image: redis:7-alpine
    container_name: retail_redis
    ports:
      - "6380:6379" # Changed to 6380 because 6379 is already used on your PC

  # -------------------------------------------------------------------------
  # ZOOKEEPER (The Manager)
  # Why: Kafka is dumb on its own. Zookeeper manages the Kafka cluster state.
  # Note: Newer Kafka versions (KRaft) don't need this, but this is standard.
  # -------------------------------------------------------------------------
  zookeeper:
    image: confluentinc/cp-zookeeper:7.4.0
    container_name: retail_zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - "2181:2181"

  # -------------------------------------------------------------------------
  # KAFKA (The Event Bus)
  # Why: Allows services to "shout" events (e.g., "OrderCreated") without knowing who listens.
  # -------------------------------------------------------------------------
  kafka:
    image: confluentinc/cp-kafka:7.4.0
    container_name: retail_kafka
    depends_on:
      - zookeeper
    ports:
      - "9092:9092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      # THE TRICKY PART (Listeners):
      # Kafka needs to know how to be reached from INSIDE and OUTSIDE docker.
      # LISTENER_DOCKER_INTERNAL: Used by other containers (e.g. Auth Service) -> kafka:29092
      # LISTENER_EXTERNAL: Used by your PC (e.g. NestJS running locally) -> localhost:9092
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:29092,PLAINTEXT_HOST://localhost:9092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      # Replication Factor 1 because we only have 1 node locally
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1

volumes:
  postgres_data:
